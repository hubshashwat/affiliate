<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Amazon Affiliate Link Generator</title>
    <style>
        /* --- CSS Variables for Theming --- */
        :root {
            /* Light Theme (Default) */
            --bg-color: #e0e5ec;
            --text-color: #333;
            --text-color-light: #666;
            --shadow-light: #ffffff;
            --shadow-dark: #a3b1c6;
            --primary-color: #007bff;
            --primary-color-hover: #0056b3;
            --success-color: #28a745;
            --error-color: #dc3545;
            --error-shadow: rgba(220, 53, 69, 0.3);
            --transition-speed: 0.3s;
        }

        body.dark-theme {
            /* Dark Theme Overrides */
            --bg-color: #2c3038;
            --text-color: #e0e5ec;
            --text-color-light: #a3b1c6;
            --shadow-light: #3a3f4a;
            --shadow-dark: #1d2025;
            --primary-color: #4dabf7;
            --primary-color-hover: #1f9aff;
            --error-shadow: rgba(255, 107, 107, 0.3);
        }

        /* --- Basic Reset & Font --- */
        body {
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: var(--bg-color);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            color: var(--text-color);
            transition: background-color var(--transition-speed) ease;
        }

        /* --- Theme Toggle Button --- */
        #theme-toggle {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--bg-color);
            color: var(--text-color);
            box-shadow: 
                5px 5px 10px var(--shadow-dark),
                -5px -5px 10px var(--shadow-light);
            transition: all var(--transition-speed) ease;
            z-index: 20;
        }
        #theme-toggle:hover {
             box-shadow: 
                inset 2px 2px 5px var(--shadow-dark),
                inset -3px -3px 7px var(--shadow-light);
        }
        
        /* --- Main Neumorphic Card Styling --- */
        .card {
            width: 100%;
            max-width: 600px;
            background: var(--bg-color);
            padding: 2.5rem;
            margin: 1rem;
            border-radius: 20px;
            box-shadow: 
                8px 8px 16px var(--shadow-dark),
                -8px -8px 16px var(--shadow-light);
            text-align: center;
            box-sizing: border-box;
            color: var(--text-color-light);
            transition: all var(--transition-speed) ease;
            position: relative;
            overflow: hidden;
        }

        h1 {
            margin-top: 0;
            color: var(--text-color);
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        p {
            margin-bottom: 2rem;
            line-height: 1.6;
        }

        /* --- Input & Button Groups (Neumorphic) --- */
        .input-group, .output-group {
            display: flex;
            margin-bottom: 1.5rem;
        }

        input[type="url"], input[type="text"] {
            flex-grow: 1;
            padding: 1rem 1.25rem;
            border: none;
            background: var(--bg-color);
            border-radius: 12px;
            font-size: 1rem;
            outline: none;
            color: var(--text-color);
            box-shadow: 
                inset 2px 2px 5px var(--shadow-dark),
                inset -3px -3px 7px var(--shadow-light);
            transition: all var(--transition-speed) ease;
        }
        
        input::placeholder {
            color: var(--text-color-light);
            opacity: 0.8;
        }

        input[type="url"]:focus {
            box-shadow: 
                inset 3px 3px 7px var(--shadow-dark),
                inset -4px -4px 9px var(--shadow-light);
        }

        button {
            padding: 1rem 2rem;
            border: none;
            background-color: var(--bg-color);
            color: var(--primary-color);
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            border-radius: 12px;
            margin-left: 1rem;
            box-shadow: 
                6px 6px 12px var(--shadow-dark),
                -6px -6px 12px var(--shadow-light);
            transition: all var(--transition-speed) ease;
            white-space: nowrap;
        }
        
        #generateBtn:hover, .output-group button:hover:not(.copied) {
            color: white;
            background-color: var(--primary-color);
            box-shadow: 
                inset 2px 2px 5px var(--shadow-dark),
                inset -3px -3px 7px var(--shadow-light);
        }
        
        .output-group { display: none; }
        
        .output-group button.copied {
            background-color: var(--success-color);
            color: white;
            box-shadow: 
                inset 2px 2px 5px var(--shadow-dark),
                inset -3px -3px 7px var(--shadow-light);
        }

        .error-message {
            display: none;
            background: var(--bg-color);
            border-radius: 12px;
            padding: 0.75rem 1rem;
            margin-bottom: 1rem;
            font-weight: 500;
            color: var(--error-color);
            box-shadow: 
                inset 2px 2px 5px var(--error-shadow),
                inset -3px -3px 7px var(--shadow-light);
            border: 1px solid var(--error-shadow);
        }
        
        .important-note {
            background: var(--bg-color);
            border-radius: 16px;
            padding: 1.5rem;
            margin-top: 2.5rem;
            text-align: left;
            font-size: 0.95rem;
            line-height: 1.6;
            color: var(--text-color-light);
            box-shadow: 
                5px 5px 10px var(--shadow-dark),
                -5px -5px 10px var(--shadow-light);
            transition: all var(--transition-speed) ease;
        }
        
        .important-note strong {
            color: var(--text-color);
            font-weight: 700;
        }

        /* --- Loader Overlay Styling --- */
        .loader-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(5px);
            border-radius: 20px;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10;
            transition: opacity 0.3s ease;
        }

        body.dark-theme .loader-overlay {
            background: rgba(44, 48, 56, 0.9);
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--bg-color);
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            box-shadow: 
                inset 2px 2px 5px var(--shadow-dark), 
                inset -2px -2px 5px var(--shadow-light);
            margin-bottom: 1.5rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--primary-color);
            text-align: center;
            padding: 0 20px;
            min-height: 1.5em;
        }

        /* --- NEW: Mobile Blocker (The Gatekeeper) --- */
        .mobile-message {
            display: none; /* Hidden on Desktop */
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 2rem;
            max-width: 90%;
        }

        .mobile-message h2 {
            font-size: 2.5rem;
            margin-bottom: 1rem;
        }

        .mobile-message p {
            font-size: 1.2rem;
            color: var(--text-color-light);
        }

        /* The Magic Query: If screen is smaller than 768px (Phones) */
        @media (max-width: 768px) {
            .card {
                display: none !important; /* Hide the app */
            }
            .mobile-message {
                display: flex !important; /* Show the warning */
            }
            #theme-toggle {
                top: 15px; right: 15px; /* Adjust theme button slightly */
            }
        }
    </style>
</head>
<body>

    <button id="theme-toggle">ðŸŒ™</button>

    <div class="mobile-message">
        <h2>ðŸ’»<br>Computer Required</h2>
        <p>This tool is restricted to Laptops, Desktops, and Tablets.</p>
        <p>Affiliate links cannot be generated reliably on mobile phones.</p>
    </div>

    <div class="card">
        <div id="loaderOverlay" class="loader-overlay">
            <div class="spinner"></div>
            <div id="loadingMessage" class="loading-text">Connecting to server...</div>
        </div>

        <h1>Desktop Amazon Affiliate Link Generator</h1>
        <p>Paste any Amazon product URL below. This tool will automatically add Shashwat's affiliate tag and create a clean link for you to share.</p>
        
        <div class="input-group">
            <input
                type="url"
                id="originalUrlInput"
                placeholder="Paste Amazon product URL here..."
            />
            <button id="generateBtn">Generate</button>
        </div>

        <div id="errorMessage" class="error-message"></div>

        <div id="outputGroup" class="output-group">
            <input type="text" id="affiliateUrlOutput" readonly />
            <button id="copyBtn">Copy</button>
            <button id="openBtn">Open â†—</button>
        </div>

        <div class="important-note">
            <strong>Important Note:</strong> If the link is used and a qualifying purchase within a <strong>24-hour window is not made</strong>, the sale will not be credited to Shashwat's Amazon Associates account.
            <br><br>
            <strong>Excluded Products:</strong> Occasionally, a product might be excluded from the affiliate program. If the affiliate link shows the item as 'Currently Unavailable', simply use the original Amazon link instead.
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const YOUR_AFFILIATE_TAG = 'shashwat15-21';
        const API_BASE_URL = 'https://affiliate-backend-upvj.onrender.com';
        const API_ENDPOINT = '/api/get-product'; 
        const MAX_WAIT_TIME_MS = 92000; // 92 Seconds

        const LOADING_MESSAGES = [
            "Waking up the server (this may take a minute)...",
            "Still waking up the hamsters...",
            "Render free tier is booting up...",
            "Pouring digital coffee...",
            "Almost there, hang tight...",
            "Just a few more seconds...",
            "Server is cold, warming it up...",
            "Optimizing the link matrix..."
        ];

        // --- DOM Elements ---
        const originalUrlInput = document.getElementById('originalUrlInput');
        const generateBtn = document.getElementById('generateBtn');
        const errorMessage = document.getElementById('errorMessage');
        const outputGroup = document.getElementById('outputGroup');
        const affiliateUrlOutput = document.getElementById('affiliateUrlOutput');
        const copyBtn = document.getElementById('copyBtn');
        const openBtn = document.getElementById('openBtn');
        const themeToggle = document.getElementById('theme-toggle');
        const loaderOverlay = document.getElementById('loaderOverlay');
        const loadingMessageEl = document.getElementById('loadingMessage');

        let messageInterval;

        // --- THEME LOGIC ---
        function setTheme(theme) {
            localStorage.setItem('theme', theme);
            if (theme === 'dark') {
                document.body.classList.add('dark-theme');
                themeToggle.textContent = 'â˜€ï¸';
            } else {
                document.body.classList.remove('dark-theme');
                themeToggle.textContent = 'ðŸŒ™';
            }
        }
        themeToggle.addEventListener('click', () => {
            const isDarkMode = document.body.classList.contains('dark-theme');
            setTheme(isDarkMode ? 'light' : 'dark');
        });
        document.addEventListener('DOMContentLoaded', () => {
            const savedTheme = localStorage.getItem('theme') || 'light';
            setTheme(savedTheme);
        });

        // --- CORE LOGIC ---
        async function handleGeneration() {
            // 1. Reset UI
            errorMessage.style.display = 'none';
            outputGroup.style.display = 'none';
            copyBtn.textContent = 'Copy';
            copyBtn.classList.remove('copied');
            
            const originalUrl = originalUrlInput.value.trim();

            if (!originalUrl) {
                showError('Please paste a URL first.');
                return;
            }

            // 2. Start Loader & Message Cycler
            showLoader();

            try {
                // 3. Attempt Backend
                const backendLink = await fetchFromBackendWithLongTimeout(originalUrl);
                showSuccess(backendLink);
            } catch (error) {
                console.warn("Backend failed or timed out. Switching to Local.", error);
                
                // 4. Fallback to Local Regex
                const localLink = generateLocalLink(originalUrl);
                if (localLink) {
                    showSuccess(localLink);
                } else {
                    showError('Could not generate link. Please check the URL.');
                }
            } finally {
                // 5. Cleanup
                hideLoader();
            }
        }

        // --- BACKEND STRATEGY ---
        function fetchFromBackendWithLongTimeout(url) {
            return new Promise((resolve, reject) => {
                const timer = setTimeout(() => {
                    reject(new Error("Timeout: 90s limit reached"));
                }, MAX_WAIT_TIME_MS);

                fetch(`${API_BASE_URL}${API_ENDPOINT}`, {
                    method: 'POST',
                    headers: { 
                        'accept': 'application/json',
                        'Content-Type': 'application/json' 
                    },
                    body: JSON.stringify({ url: url })
                })
                .then(async response => {
                    clearTimeout(timer);
                    if (!response.ok) {
                        throw new Error(`Server Error: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data && data.affiliateLink) {
                        resolve(data.affiliateLink);
                    } else {
                        reject(new Error("Invalid API response: Missing affiliateLink"));
                    }
                })
                .catch(err => {
                    clearTimeout(timer);
                    reject(err);
                });
            });
        }

        // --- LOCAL STRATEGY (FALLBACK) ---
        function generateLocalLink(originalUrl) {
            const regex = /\/(dp|gp\/product)\/([A-Z0-9]{10})/;
            const match = originalUrl.match(regex);
            if (match && match[2]) {
                return `https://www.amazon.in/dp/${match[2]}/?tag=${YOUR_AFFILIATE_TAG}`;
            }
            return null;
        }

        // --- UI HELPERS ---
        function showLoader() {
            loaderOverlay.style.display = 'flex';
            let msgIndex = 0;
            loadingMessageEl.textContent = LOADING_MESSAGES[0];
            
            messageInterval = setInterval(() => {
                msgIndex = (msgIndex + 1) % LOADING_MESSAGES.length;
                loadingMessageEl.textContent = LOADING_MESSAGES[msgIndex];
            }, 6000);
        }

        function hideLoader() {
            loaderOverlay.style.display = 'none';
            clearInterval(messageInterval);
        }

        function showSuccess(link) {
            affiliateUrlOutput.value = link;
            outputGroup.style.display = 'flex';
        }

        function showError(msg) {
            errorMessage.textContent = msg;
            errorMessage.style.display = 'block';
        }

        function copyToClipboard() {
            if (!affiliateUrlOutput.value) return;
            navigator.clipboard.writeText(affiliateUrlOutput.value).then(() => {
                copyBtn.textContent = 'Copied!';
                copyBtn.classList.add('copied');
                setTimeout(() => {
                    copyBtn.textContent = 'Copy';
                    copyBtn.classList.remove('copied');
                }, 2000);
            });
        }

        function openInNewTab() {
            if (!affiliateUrlOutput.value) return;
            window.open(affiliateUrlOutput.value, '_blank');
        }

        // --- EVENT LISTENERS ---
        generateBtn.addEventListener('click', handleGeneration);
        copyBtn.addEventListener('click', copyToClipboard);
        openBtn.addEventListener('click', openInNewTab);
        originalUrlInput.addEventListener('keyup', (e) => {
            if (e.key === 'Enter') handleGeneration();
        });
    </script>

</body>
</html>